<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertiFier - Definitive Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glass-card { background: rgba(22, 27, 34, 0.6); border: 1px solid rgba(56, 189, 248, 0.2); }
        .main-gradient-text { background: linear-gradient(135deg, #06b6d4, #0891b2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #0e7490; color: white; }
        .input-style { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background-color: rgba(255,255,255,0.8); }
        .dark .input-style { background-color: rgba(30,41,59,0.8); border-color: #4b5563; }
        .input-style.invalid { border-color: #ef4444 !important; }
        .file-input-style { font-size: 0.875rem; color: #6b7280; }
        .dark .file-input-style { color: #9ca3af; }
        .req-list li.valid { color: #22c55e; text-decoration: line-through; } 
        .req-list li.invalid { color: #ef4444; }
        .table-style { width: 100%; border-collapse: collapse; }
        .table-style th, .table-style td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .dark .table-style th, .dark .table-style td { border-color: #374151; }
        .table-style th { font-weight: 600; font-size: 0.875rem; color: #4b5563; dark:color: #9ca3af; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-300">

    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        <div id="dashboard-view" class="hidden md:flex flex-col w-full md:w-64 main-gradient-bg text-white flex-shrink-0">
            <div class="p-6 text-center border-b border-cyan-600"><h1 class="text-2xl font-bold tracking-wider">Certificate Verifier</h1><span class="text-sm text-cyan-200">Admin Panel</span></div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#" class="sidebar-link active flex items-center p-3 rounded-lg" data-target="overview-panel">Overview</a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-target="register-panel">Register Institution</a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-target="bulk-upload-panel">Bulk Upload CSV</a>
            </nav>
            <div class="p-4 mt-auto"><button id="switchToUserViewBtn" class="w-full bg-cyan-100 text-cyan-800 font-semibold p-3 rounded-lg hover:bg-white transition">Switch to User View</button></div>
        </div>

        <main id="main-content" class="w-full flex-grow p-4 sm:p-6 md:p-8">
            <div id="user-view">
                <header class="flex justify-between items-center mb-10"><h1 class="text-3xl font-bold main-gradient-text">Certificate Verifier</h1><button id="switchToAdminViewBtn" class="hidden md:block bg-slate-200 dark:bg-slate-700 font-semibold px-4 py-2 rounded-lg">Admin Login</button></header>
                <div class="max-w-2xl mx-auto text-center"><h2 class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white mb-4">Verify Academic Credentials Instantly.</h2><p class="text-lg text-slate-600 dark:text-slate-400 mb-10">Upload a certificate to check its authenticity.</p></div>
                <div class="max-w-xl mx-auto p-8 glass-card rounded-2xl shadow-xl">
                    <div id="drag-drop-area" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-10 text-center cursor-pointer"><svg class="w-16 h-16 mx-auto text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><p class="mt-4 font-semibold">Drag & drop your file here</p><p class="text-sm text-slate-500">or</p><label for="file-upload" class="mt-2 inline-block bg-cyan-500 text-white font-semibold px-5 py-2 rounded-lg cursor-pointer">Browse File</label><input id="file-upload" type="file" class="hidden" accept="image/jpeg, image/png"><p id="file-name" class="mt-3 text-sm font-medium">No file selected.</p></div>
                    <button id="verify-btn" type="button" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-6" disabled>Verify Certificate</button>
                </div>
            </div>

            <div id="admin-login-view" class="hidden max-w-md mx-auto">
                <div class="text-center mb-10"><h1 class="text-3xl font-bold main-gradient-text">Admin Portal</h1><p class="mt-2">Requires a valid institutional email.</p></div>
                <div class="p-8 glass-card rounded-2xl shadow-xl">
                    <form id="login-form" class="space-y-6">
                        <div><label for="email" class="block text-sm font-medium">Institutional Email</label>
                            <input type="email" id="email" name="email" class="input-style" value="admin@gmail.com" required>
                        </div>
                        <div><label for="password" class="block text-sm font-medium">Password</label>
                            <input type="password" id="password" name="password" class="input-style" value="P@ssword123" required> </div>
                        <ul id="password-reqs" class="text-sm space-y-1">
                            <li id="req-length" class="req-list invalid">At least 8 characters</li>
                            <li id="req-number" class="req-list invalid">Contains at least one number (0-9)</li>
                            <li id="req-special" class="req-list invalid">Contains at least one special character (!@#...)</li>
                        </ul>
                        <div id="login-feedback" class="text-center text-red-500 font-semibold h-4"></div>
                        <button id="login-btn" type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Sign In</button> </form>
                </div>
            </div>

            <div id="admin-content" class="hidden">
                <div id="overview-panel" class="dashboard-panel space-y-10">
                    <div>
                        <h2 class="text-3xl font-bold mb-6">Live System Overview</h2>
                        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-2">
                            <h3 class="text-2xl font-bold mb-4">Forgery Trends</h3>
                            <div id="forgery-trends-container" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <p>Loading trends...</p>
                            </div>
                        </div>
                        <div class="lg:col-span-3">
                            <h3 class="text-2xl font-bold mb-4">Live Forgery Alerts</h3>
                            <div id="live-alerts-container" class="bg-white dark:bg-slate-800 p-2 md:p-4 rounded-xl shadow-md overflow-x-auto">
                               <p class="p-4">Loading alerts...</p>
                            </div>
                        </div>
                    </div>
                    </div>
                <div id="register-panel" class="dashboard-panel hidden">
                    <h2 class="text-3xl font-bold mb-6">Onboard New Institution</h2>
                    <div class="glass-card p-8 rounded-xl">
                        <form id="register-form" class="space-y-4">
                            <div><label>Institution Name</label><input type="text" id="inst-name" name="name" required class="input-style"></div>
                            <div><label>Official Logo (.png)</label><input type="file" id="inst-logo" name="logo" required accept="image/png" class="mt-1 block w-full file-input-style"></div>
                            <button type="submit" class="w-full bg-cyan-500 text-white font-bold py-3 rounded-lg">Register Institution</button>
                        </form>
                        <div id="register-feedback" class="mt-4 text-center font-semibold"></div>
                    </div>
                </div>
                <div id="bulk-upload-panel" class="dashboard-panel hidden">
                    <h2 class="text-3xl font-bold mb-6">Bulk Upload Certificate Data</h2>
                    <div class="glass-card p-8 rounded-xl">
                         <form id="bulk-upload-form" class="space-y-4">
                            <div><label>Institution Name (Must be registered)</label><input type="text" id="bulk-inst-name" name="institution_name" required class="input-style"></div>
                            <div><label>Certificate Data (CSV File)</label><input type="file" id="csv-file" name="csv_file" required accept=".csv" class="mt-1 block w-full file-input-style"></div>
                            <button type="submit" class="w-full bg-cyan-500 text-white font-bold py-3 rounded-lg">Upload Records</button>
                        </form>
                        <div id="bulk-feedback" class="mt-4 text-center font-semibold"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div id="result-card-genuine" class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-8 transform transition-all hidden">
            <div class="text-center"><div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center"><span class="text-5xl">✅</span></div><h2 class="text-3xl font-bold text-green-600 mt-4">Genuine Certificate</h2><p class="mt-2">This document has been successfully verified.</p></div>
            <div class="mt-8 space-y-4 bg-slate-50 dark:bg-slate-700 p-6 rounded-lg"><div class="flex justify-between"><span>Name:</span> <span id="genuine-name" class="font-semibold"></span></div><div class="flex justify-between"><span>Course:</span> <span id="genuine-course" class="font-semibold"></span></div><div class="flex justify-between"><span>Reg. No:</span> <span id="genuine-regno" class="font-semibold"></span></div></div>
            <div class="mt-6 text-center"><h3 class="font-semibold mb-2">Blockchain Hash</h3><code id="blockchain-hash" class="text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded break-all"></code></div>
            <div class="mt-6 text-center"><h3 class="font-semibold mb-2">Verification Stamp</h3><div class="flex justify-center p-2 bg-white rounded-lg"><img id="qr-code-img" alt="QR Code" class="w-32 h-32" /></div></div>
            <button class="close-modal-btn w-full mt-8 bg-slate-200 dark:bg-slate-600 font-bold py-3 rounded-lg">Close</button>
        </div>
        <div id="result-card-forgery" class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-8 transform transition-all hidden">
            <div class="text-center"><div class="w-20 h-20 mx-auto bg-red-100 rounded-full flex items-center justify-center"><span class="text-5xl">❌</span></div><h2 class="text-3xl font-bold text-red-600 mt-4">Suspected Forgery</h2><p class="mt-2">This document could not be verified.</p></div>
            <div class="mt-8 bg-red-50 dark:bg-red-900/20 p-6 rounded-lg border border-red-200 dark:border-red-500/30"><h3 class="font-bold text-red-800 dark:text-red-400 mb-2">Reason:</h3><p id="forgery-reason" class="text-red-700 dark:text-red-300"></p></div>
            <button class="close-modal-btn w-full mt-8 bg-slate-200 dark:bg-slate-600 font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <script>
    // NEW LOGIC: Function to handle blacklisting from the UI
    async function blacklistOffender(regNo, instId) {
        const reason = prompt("Enter reason for blacklisting:", "Confirmed Forgery");
        if (reason) {
            const formData = new FormData();
            formData.append('reg_no', regNo);
            formData.append('inst_id', instId);
            formData.append('reason', reason);
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/blacklist', { method: 'POST', body: formData });
                const data = await response.json();
                alert(data.message);
                fetchAndDisplayDashboardIntelligence(); // Refresh the dashboard
            } catch (error) {
                alert('Failed to connect to the server to blacklist.');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- Element References ---
        const userView = document.getElementById('user-view'), adminLoginView = document.getElementById('admin-login-view'), dashboardView = document.getElementById('dashboard-view'), adminContent = document.getElementById('admin-content'), switchToAdminViewBtn = document.getElementById('switchToAdminViewBtn'), switchToUserViewBtn = document.getElementById('switchToUserViewBtn'), loginForm = document.getElementById('login-form'), loginBtn = document.getElementById('login-btn'), loginFeedback = document.getElementById('login-feedback'), verifyBtn = document.getElementById('verify-btn'), modal = document.getElementById('result-modal'), closeBtns = document.querySelectorAll('.close-modal-btn'), genuineCard = document.getElementById('result-card-genuine'), forgeryCard = document.getElementById('result-card-forgery'), sidebarLinks = document.querySelectorAll('.sidebar-link'), dashboardPanels = document.querySelectorAll('.dashboard-panel'), registerForm = document.getElementById('register-form'), bulkUploadForm = document.getElementById('bulk-upload-form'), dragArea = document.getElementById('drag-drop-area'), fileInput = document.getElementById('file-upload'), fileNameDisplay = document.getElementById('file-name');
        let selectedFile = null;

        // --- Theme Switcher ---
        const themeToggleBtn = document.createElement('button');
        themeToggleBtn.innerHTML = '🌙';
        themeToggleBtn.className = 'fixed bottom-4 right-4 w-12 h-12 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm border rounded-full text-2xl flex items-center justify-center shadow-lg z-50';
        document.body.appendChild(themeToggleBtn);
        const themeCheck = () => { if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); themeToggleBtn.innerHTML = '☀️'; } else { document.documentElement.classList.remove('dark'); themeToggleBtn.innerHTML = '🌙'; } };
        const themeSwitch = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); themeCheck(); };
        themeToggleBtn.addEventListener('click', themeSwitch);
        themeCheck();

        // --- View & Panel Switching ---
        switchToAdminViewBtn.addEventListener('click', () => { userView.classList.add('hidden'); adminLoginView.classList.remove('hidden'); });
        switchToUserViewBtn.addEventListener('click', () => { userView.classList.remove('hidden'); adminLoginView.classList.add('hidden'); dashboardView.classList.add('hidden'); dashboardView.classList.remove('flex'); adminContent.classList.add('hidden'); });
        sidebarLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const target = link.dataset.target; sidebarLinks.forEach(l => l.classList.remove('active')); link.classList.add('active'); dashboardPanels.forEach(p => p.classList.toggle('hidden', p.id !== target)); }); });

        // --- Admin Login ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginFeedback.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            const formData = new FormData(loginForm);
            try {
                const response = await fetch('http://127.0.0.1:8000/admin/login', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.status === 'success') {
                    adminLoginView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    dashboardView.classList.add('flex');
                    adminContent.classList.remove('hidden');
                    fetchAndDisplayDashboardIntelligence(); // UPDATED FUNCTION CALL
                } else {
                    loginFeedback.textContent = data.message;
                }
            } catch (error) {
                loginFeedback.textContent = 'Connection to server failed.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        // --- Admin Forms ---
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = new FormData(registerForm); const fb = document.getElementById('register-feedback'); fb.textContent = 'Registering...'; try { const r = await fetch('http://127.0.0.1:8000/institution/register', { method: 'POST', body: f }); fb.textContent = (await r.json()).message; } catch { fb.textContent = 'Registration failed.'; } });
        bulkUploadForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = new FormData(bulkUploadForm); const fb = document.getElementById('bulk-feedback'); fb.textContent = 'Uploading...'; try { const r = await fetch('http://127.0.0.1:8000/institution/bulk_upload_csv', { method: 'POST', body: f }); fb.textContent = (await r.json()).message; } catch { fb.textContent = 'Upload failed.'; } });
        
        // NEW LOGIC: Replaced old stats function with a full intelligence dashboard fetcher
        async function fetchAndDisplayDashboardIntelligence() {
            const statsGrid = document.getElementById('stats-grid');
            const trendsContainer = document.getElementById('forgery-trends-container');
            const alertsContainer = document.getElementById('live-alerts-container');
            statsGrid.innerHTML = '<p>Loading stats...</p>';
            trendsContainer.innerHTML = '<p>Loading trends...</p>';
            alertsContainer.innerHTML = '<p class="p-4">Loading alerts...</p>';
            
            // Fetch Basic Stats
            try {
                const statsResponse = await fetch('http://127.0.0.1:8000/dashboard/live_stats');
                const statsData = await statsResponse.json();
                statsGrid.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md"><h3>Total Records</h3><p class="text-4xl font-bold">${statsData.total_records_in_db}</p></div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md"><h3>Institutions</h3><p class="text-4xl font-bold">${statsData.registered_institutions}</p></div>`;
            } catch {
                statsGrid.innerHTML = '<p class="text-red-500">Failed to load stats.</p>';
            }

            // Fetch Intelligence Data (Trends & Alerts)
            try {
                const intelResponse = await fetch('http://127.0.0.1:8000/dashboard/live_intelligence');
                const intelData = await intelResponse.json();

                // Render Forgery Trends
                if (intelData.forgery_trends.length > 0) {
                    trendsContainer.innerHTML = intelData.forgery_trends.map(t => `
                        <div class="flex justify-between items-center py-2">
                            <span class="font-medium">${t.institution_name}</span>
                            <span class="bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 font-bold text-sm px-3 py-1 rounded-full">${t.forgery_count}</span>
                        </div>
                    `).join('');
                } else {
                    trendsContainer.innerHTML = '<p>No forgery attempts recorded yet.</p>';
                }

                // Render Live Alerts
                if (intelData.alerts.length > 0) {
                    alertsContainer.innerHTML = `
                        <table class="table-style text-sm">
                            <thead><tr><th>Timestamp</th><th>Institution</th><th>Reg. No</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody>
                                ${intelData.alerts.map(a => `
                                    <tr>
                                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                                        <td>${a.institution_name}</td>
                                        <td class="font-mono">${a.provided_reg_no}</td>
                                        <td><span class="text-yellow-600 dark:text-yellow-400">${a.status}</span></td>
                                        <td><button onclick="blacklistOffender('${a.provided_reg_no}', ${a.institution_id})" class="bg-red-500 text-white font-bold px-3 py-1 text-xs rounded-md hover:bg-red-600">Blacklist</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`;
                } else {
                    alertsContainer.innerHTML = '<p class="p-4">No active alerts requiring attention.</p>';
                }
            } catch {
                trendsContainer.innerHTML = '<p class="text-red-500">Failed to load trends.</p>';
                alertsContainer.innerHTML = '<p class="text-red-500 p-4">Failed to load alerts.</p>';
            }
        }

        // --- Certificate Verification ---
        const handleFile = (files) => { if (files.length > 0) { selectedFile = files[0]; fileNameDisplay.textContent = selectedFile.name; verifyBtn.disabled = false; } };
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); dragArea.classList.add('border-cyan-500'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('border-cyan-500'));
        dragArea.addEventListener('drop', (e) => { e.preventDefault(); dragArea.classList.remove('border-cyan-500'); handleFile(e.dataTransfer.files); });
        fileInput.addEventListener('change', () => handleFile(fileInput.files));
        dragArea.addEventListener('click', () => fileInput.click());
        verifyBtn.addEventListener('click', async () => { if (!selectedFile) return; verifyBtn.disabled = true; verifyBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75" fill="currentColor"></path></svg>`; const f = new FormData(); f.append('file', selectedFile); try { const r = await fetch('http://127.0.0.1:8000/verify/certificate_live', { method: 'POST', body: f }); displayModal(await r.json()); } catch { displayModal({ status: 'Error', message: 'Connection to backend failed.' }); } finally { verifyBtn.disabled = false; verifyBtn.textContent = 'Verify Certificate'; } });
        
        // --- Modal Display Logic ---
        const displayModal = (data) => {
            modal.classList.remove('hidden');
            if (data.status === 'Genuine') {
                document.getElementById('genuine-name').textContent = data.details.name;
                document.getElementById('genuine-course').textContent = data.details.course;
                document.getElementById('genuine-regno').textContent = data.details.registration_no;
                document.getElementById('blockchain-hash').textContent = data.details.blockchain_hash;
                document.getElementById('qr-code-img').src = `data:image/png;base64,${data.qr_code_base64}`;
                forgeryCard.classList.add('hidden');
                genuineCard.classList.remove('hidden');
            } else {
                document.getElementById('forgery-reason').textContent = data.message;
                genuineCard.classList.add('hidden');
                forgeryCard.classList.remove('hidden');
            }
        };
        closeBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));

        // Simplified login button enabling for convenience
        document.getElementById('password').dispatchEvent(new Event('input', { bubbles: true }));
    });
    </script>
</body>
</html>